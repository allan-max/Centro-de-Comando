<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Centro de Comando</title>
<style>
  * { box-sizing: border-box; }
  body { background-color: #0d1117; color: #c9d1d9; font-family: 'Courier New', Courier, monospace; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
  
  /* --- TELA DE LOGIN --- */
  #tela-login { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 15px; }
  .login-box { background-color: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 30px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
  .login-box h2 { color: #58a6ff; margin-top: 0; margin-bottom: 20px; }
  .input-group { margin-bottom: 15px; text-align: left; }
  .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #8b949e; }
  .input-group input { width: 100%; padding: 10px; background-color: #0d1117; border: 1px solid #30363d; color: #c9d1d9; border-radius: 4px; font-family: inherit; }
  .btn-entrar { background-color: #238636; color: white; border: none; padding: 10px; width: 100%; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; }
  .btn-entrar:hover { background-color: #2ea043; }
  #msg-erro { color: #f85149; font-size: 0.85rem; margin-top: 10px; display: none; }

  /* --- NAVBAR (MENU HAMB√öRGUER) --- */
  #navbar { display: none; background-color: #161b22; border-bottom: 1px solid #30363d; padding: 10px 20px; align-items: center; justify-content: space-between; }
  .nav-title { color: #58a6ff; font-weight: bold; font-size: 1.2rem; }
  .hamburger { cursor: pointer; font-size: 1.5rem; background: none; border: none; color: #c9d1d9; }
  .menu-links { display: none; gap: 15px; }
  .menu-links.ativo { display: flex; }
  .nav-btn { background: none; border: 1px solid #30363d; color: #c9d1d9; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; }
  .nav-btn:hover { background-color: #30363d; }
  .nav-btn.danger { color: #f85149; border-color: #f85149; }
  .nav-btn.danger:hover { background-color: #f85149; color: white; }

  /* --- √ÅREAS DE CONTE√öDO --- */
  .conteudo { display: none; padding: 15px; flex: 1; flex-direction: column; }
  
  /* Se√ß√£o Logs */
  .header-logs { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
  .btn-reiniciar { background-color: #238636; color: #ffffff; border: 1px solid rgba(240, 246, 252, 0.1); padding: 8px 16px; font-weight: bold; border-radius: 6px; cursor: pointer; }
  .container-grids { display: flex; flex-wrap: wrap; gap: 20px; flex: 1; }
  .terminal-box { flex: 1 1 calc(50% - 20px); background-color: #010409; border: 1px solid #30363d; border-radius: 6px; display: flex; flex-direction: column; min-height: 250px; max-height: 40vh; }
  .terminal-header { background-color: #161b22; padding: 8px; text-align: center; font-weight: bold; border-bottom: 1px solid #30363d; font-size: 0.85rem; }
  .terminal-body { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; }

  /* Se√ß√£o Terminal Remoto */
  .terminal-controls { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
  .terminal-controls select, .terminal-controls button, .terminal-controls input { padding: 8px; background-color: #0d1117; border: 1px solid #30363d; color: #c9d1d9; border-radius: 4px; font-family: inherit; }
  .btn-start-shell { background-color: #1f6feb; border-color: #1f6feb; color: white; cursor: pointer; }
  .btn-stop-shell { background-color: #da3633; border-color: #da3633; color: white; cursor: pointer; display: none; }
  #shell-output { flex: 1; background-color: #010409; border: 1px solid #30363d; padding: 10px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem; min-height: 300px; margin-bottom: 10px; }
  .input-comando-wrapper { display: flex; gap: 10px; }
  #input-comando { flex: 1; }

  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-thumb { background-color: #6e7681; border-radius: 10px; }

  @media (max-width: 768px) {
    .menu-links { flex-direction: column; position: absolute; top: 50px; right: 20px; background-color: #161b22; padding: 10px; border: 1px solid #30363d; border-radius: 6px; }
    .terminal-box { flex: 1 1 100%; }
  }
</style>
</head>
<body>

  <div id="tela-login">
      <div class="login-box">
          <h2>üîê Acesso Restrito</h2>
          <div class="input-group"><label>Usu√°rio</label><input type="text" id="usuario"></div>
          <div class="input-group"><label>Senha</label><input type="password" id="senha"></div>
          <button class="btn-entrar" onclick="fazerLogin()">ENTRAR</button>
          <div id="msg-erro">Credenciais incorretas!</div>
      </div>
  </div>

  <div id="navbar">
      <div class="nav-title">üåê Ventura CMD</div>
      <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
      <div class="menu-links" id="menu-links">
          <button class="nav-btn" onclick="mostrarSecao('logs')">Monitor de Logs</button>
          <button class="nav-btn" onclick="mostrarSecao('terminal')">Terminal Remoto</button>
          <button class="nav-btn danger" onclick="fazerLogoff()">Sair</button>
          <button class="nav-btn" onclick="mostrarSecao('sessoes')">Sess√µes Ativas</button>
      </div>
  </div>

  <div id="secao-logs" class="conteudo">
      <div class="header-logs">
          <h2>Monitoramento em Tempo Real</h2>
          <button class="btn-reiniciar" onclick="enviarComandoReiniciar()">üöÄ REINICIAR DEPLOY</button>
      </div>
      <div class="container-grids">
        <div class="terminal-box"><div class="terminal-header">ü§ñ Bot WhatsApp</div><div class="terminal-body" id="log-node"></div></div>
        <div class="terminal-box"><div class="terminal-header">üêç API Datasheet</div><div class="terminal-body" id="log-python"></div></div>
        <div class="terminal-box"><div class="terminal-header">‚öôÔ∏è HSE (.NET)</div><div class="terminal-body" id="log-hse"></div></div>
        <div class="terminal-box"><div class="terminal-header">üö® Deploy Webhook</div><div class="terminal-body" id="log-deploy"></div></div>
      </div>
  </div>

  <div id="secao-terminal" class="conteudo">
      <h2>Prompt de Comando Remoto</h2>
      <div class="terminal-controls">
          <select id="tipo-shell">
              <option value="cmd">CMD (Prompt de Comando)</option>
              <option value="powershell">PowerShell</option>
          </select>
          <button class="btn-start-shell" id="btn-start" onclick="iniciarShell()">Iniciar Sess√£o</button>
          <button class="btn-stop-shell" id="btn-stop" onclick="pararShell()">Encerrar Sess√£o</button>
      </div>
      
      <div id="shell-output">Aguardando conex√£o com o servidor...</div>
      
      <div class="input-comando-wrapper">
          <input type="text" id="input-comando" placeholder="Digite um comando e aperte ENTER..." onkeypress="verificarEnter(event)" disabled>
          <button class="nav-btn" onclick="enviarComandoShell()" id="btn-enviar" disabled>Enviar</button>
      </div>
  </div>
  <div id="secao-sessoes" class="conteudo">
    <h2>üë• Usu√°rios Conectados</h2>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background-color: #161b22; border: 1px solid #30363d;">
            <thead>
                <tr style="background-color: #0d1117; color: #58a6ff;">
                    <th style="padding: 10px; border: 1px solid #30363d;">IP</th>
                    <th style="padding: 10px; border: 1px solid #30363d;">Entrada</th>
                    <th style="padding: 10px; border: 1px solid #30363d;">Status</th>
                    <th style="padding: 10px; border: 1px solid #30363d;">A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabela-sessoes">
                </tbody>
        </table>
    </div>
</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
      const socket = io();

      // NAVEGA√á√ÉO
      function toggleMenu() { document.getElementById('menu-links').classList.toggle('ativo'); }
      function mostrarSecao(secao) {
        document.getElementById('secao-logs').style.display = secao === 'logs' ? 'flex' : 'none';
        document.getElementById('secao-terminal').style.display = secao === 'terminal' ? 'flex' : 'none';
        document.getElementById('secao-sessoes').style.display = secao === 'sessoes' ? 'flex' : 'none';
        if(secao === 'sessoes') socket.emit('pedir_lista_sessoes');
        document.getElementById('menu-links').classList.remove('ativo');
    }

    // Escuta a lista de sess√µes enviada pelo Agente
    socket.on('lista_sessoes', (sessoes) => {
        const corpo = document.getElementById('tabela-sessoes');
        corpo.innerHTML = '';
        sessoes.forEach(s => {
            corpo.innerHTML += `
                <tr>
                    <td style="padding: 10px; border: 1px solid #30363d;">${s.ip}</td>
                    <td style="padding: 10px; border: 1px solid #30363d;">${s.hora}</td>
                    <td style="padding: 10px; border: 1px solid #30363d; color: #3fb950;">Ativo</td>
                    <td style="padding: 10px; border: 1px solid #30363d;">
                        <button onclick="derrubarSessao('${s.socketId}')" style="background-color: #da3633; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Derrubar</button>
                    </td>
                </tr>`;
        });
    });

    function derrubarSessao(id) {
        if(confirm("Deseja desconectar este usu√°rio?")) {
            socket.emit('solicitar_expulsao', { targetSocketId: id });
        }
    }

    // Se o servidor te expulsar, ele limpa tudo
    socket.on('voce_foi_expulso', () => {
        alert("Sua sess√£o foi encerrada por um administrador.");
        fazerLogoff();
    });

      // LOGIN E LOGOFF
      window.onload = () => {
          const t = localStorage.getItem('ventura_token');
          if (t) socket.emit('validar_token_solicitado', { token: t });
      };

      function fazerLogin() {
          const u = document.getElementById('usuario').value;
          const s = document.getElementById('senha').value;
          socket.emit('login_solicitado', { usuario: u, senha: s });
      }

      function fazerLogoff() {
          localStorage.removeItem('ventura_token');
          location.reload();
      }

      socket.on('login_sucesso', (dados) => {
          if (dados.token) localStorage.setItem('ventura_token', dados.token);
          document.getElementById('tela-login').style.display = 'none';
          document.getElementById('navbar').style.display = 'flex';
          mostrarSecao('logs');
      });

      socket.on('login_erro', (dados) => {
          document.getElementById('msg-erro').style.display = 'block';
          localStorage.removeItem('ventura_token');
      });

      // RENDERIZA√á√ÉO DE LOGS (Inalterado)
      function adicionarLog(containerId, texto) {
          const container = document.getElementById(containerId);
          const div = document.createElement('div');
          div.style.borderBottom = "1px dashed #30363d";
          div.innerText = texto; 
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;
      }

      socket.on('novo_log_node', (l) => adicionarLog('log-node', l));
      socket.on('novo_log_python', (l) => adicionarLog('log-python', l));
      socket.on('novo_console-log', (l) => adicionarLog('log-hse', l));
      socket.on('novo_log_deploy', (l) => adicionarLog('log-deploy', l));

      function enviarComandoReiniciar() {
          if(confirm("Reiniciar tudo?")) {
              socket.emit('solicitar_reiniciar', { chave: 'cadaallan' }); // <--- SENHA AQUI
              alert("Comando enviado!");
          }
      }

      // ==========================================
      // L√ìGICA DO TERMINAL REMOTO
      // ==========================================
      const outShell = document.getElementById('shell-output');
      const inputShell = document.getElementById('input-comando');
      const btnStart = document.getElementById('btn-start');
      const btnStop = document.getElementById('btn-stop');
      const btnEnviar = document.getElementById('btn-enviar');

      function iniciarShell() {
          const tipo = document.getElementById('tipo-shell').value;
          socket.emit('iniciar_shell', { tipo: tipo });
          outShell.innerText = `Iniciando ${tipo.toUpperCase()}...\n`;
          btnStart.style.display = 'none';
          btnStop.style.display = 'inline-block';
          inputShell.disabled = false;
          btnEnviar.disabled = false;
          inputShell.focus();
      }

      function pararShell() {
          socket.emit('parar_shell');
          btnStart.style.display = 'inline-block';
          btnStop.style.display = 'none';
          inputShell.disabled = true;
          btnEnviar.disabled = true;
      }

      function enviarComandoShell() {
          const cmd = inputShell.value;
          if(cmd.trim() !== '') {
              socket.emit('comando_shell', { comando: cmd });
              inputShell.value = '';
          }
      }

      function verificarEnter(e) {
          if (e.key === 'Enter') enviarComandoShell();
      }

      socket.on('shell_output', (texto) => {
          outShell.innerText += texto;
          outShell.scrollTop = outShell.scrollHeight;
      });

      socket.on('shell_fechado', () => {
          outShell.innerText += "\n[Sess√£o Encerrada pelo Servidor]\n";
          pararShell();
      });
  </script>
</body>
</html>